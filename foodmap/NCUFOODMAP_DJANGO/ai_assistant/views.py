from django.shortcuts import render
from django.http import JsonResponse
from django.conf import settings
from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_POST, require_GET
import json
import requests
import logging
from .models import ChatHistory

# è¨­ç½®æ—¥èªŒ
logger = logging.getLogger(__name__)

def get_ai_response(message, current_page):
    """AIåŠ©æ‰‹ï¼šç¶²ç«™å°è¦½èˆ‡åŠŸèƒ½ä»‹ç´¹ï¼Œé‡åˆ°å¥åº·/ç‡Ÿé¤Š/é£²é£Ÿ/ç–¾ç—…å•é¡Œæ™‚å¼•å°ï¼Œå…¶ä»–å•é¡Œå‘¼å«Together AIç”Ÿæˆèªªæ˜ã€‚"""
    API_KEY = settings.TOGETHER_API_KEY
    logger.info(f"Using API KEY: {API_KEY[:5]}...")

    # å¥åº·/ç‡Ÿé¤Š/é£²é£Ÿ/ç–¾ç—…é—œéµå­—
    health_keywords = [
        "æ¸›è‚¥", "æ¸›é‡", "ç˜¦èº«", "æ¸›è„‚", "é«”é‡", "è›‹ç™½è³ª", "ç‡Ÿé¤Š", "ç¶­ç”Ÿç´ ", "ç¤¦ç‰©è³ª", "è†³é£Ÿçº–ç¶­", "ç¢³æ°´åŒ–åˆç‰©", "è„‚è‚ª", "ç†±é‡", "å¡è·¯é‡Œ", "ç´ é£Ÿ", "ç³–å°¿ç—…", "é«˜è¡€å£“", "é«˜è¡€è„‚", "å¿ƒè‡Ÿç—…", "è…è‡Ÿç—…", "è‚è‡Ÿç—…", "ç—›é¢¨", "éæ•", "é£²é£Ÿ", "å¥åº·", "ç–¾ç—…", "é£²é£ŸåŸå‰‡", "é£²é£Ÿå»ºè­°", "å¥åº·å»ºè­°"
    ]
    if any(keyword in message for keyword in health_keywords):
        return "æ‚¨å¥½ï¼Œé—œæ–¼å¥åº·ã€ç‡Ÿé¤Šã€é£²é£Ÿç›¸é—œçš„å•é¡Œï¼Œå»ºè­°æ‚¨ä½¿ç”¨ã€AIé£Ÿç‰©ç‡Ÿé¤Šåˆ†æã€åŠŸèƒ½é€²è¡Œé£Ÿç‰©æˆåˆ†åˆ†æï¼Œæˆ–æŸ¥çœ‹ã€å€‹äººé£²é£Ÿæ—¥è¨˜ã€å’Œã€ç‡Ÿé¤Šå„€è¡¨æ¿ã€ä¾†è¿½è¹¤æ‚¨çš„é£²é£Ÿç‹€æ³ã€‚æœ¬ AI åŠ©æ‰‹ä¸»è¦æä¾›ç¶²ç«™å°è¦½èˆ‡åŠŸèƒ½èªªæ˜ã€‚"

    # è©³ç´°çš„é é¢åŠŸèƒ½èªªæ˜
    page_details = {
        "home": {
            "name": "é¦–é ",
            "intro": "æ­¡è¿ä¾†åˆ° NCU é£Ÿç‰©åœ°åœ–ï¼é€™è£¡æ˜¯æ‚¨æ¢ç´¢ä¸­å¤®å¤§å­¸ç¾é£Ÿä¸–ç•Œçš„èµ·é»ã€‚",
            "features": [
                "ğŸ  ç€è¦½ç¶²ç«™ä¸»è¦åŠŸèƒ½æ¦‚è¦½",
                "ğŸ½ï¸ å¿«é€Ÿé€²å…¥é¤å»³åœ°åœ–ã€ç‡Ÿé¤Šåˆ†æç­‰æ ¸å¿ƒåŠŸèƒ½",
                "ğŸ“° æŸ¥çœ‹æœ€æ–°ç¾é£Ÿæ–‡ç« èˆ‡æ ¡åœ’é£²é£Ÿè³‡è¨Š",
                "ğŸ‘¥ è¨ªå•ç¤¾äº¤åŠŸèƒ½ï¼Œèˆ‡åŒå­¸åˆ†äº«ç¾é£Ÿç¶“é©—",
                "ğŸ¯ ä½¿ç”¨å¿«é€Ÿå°èˆªå‰å¾€å„å€‹åŠŸèƒ½é é¢"
            ],
            "how_to": "é»æ“Šå°èˆªæ¬„æˆ–é¦–é å¡ç‰‡å³å¯é€²å…¥ç›¸æ‡‰åŠŸèƒ½ã€‚å»ºè­°å…ˆå¾åœ°åœ–åŠŸèƒ½é–‹å§‹æ¢ç´¢é™„è¿‘é¤å»³ï¼"
        },
        "map": {
            "name": "é¤å»³åœ°åœ–",
            "intro": "æ¢ç´¢ä¸­å¤®å¤§å­¸å‘¨é‚Šçš„æ‰€æœ‰ç¾é£Ÿé¸æ“‡ï¼äº’å‹•å¼åœ°åœ–è®“æ‚¨è¼•é¬†æ‰¾åˆ°å¿ƒå„€çš„é¤å»³ã€‚",
            "features": [
                "ğŸ—ºï¸ äº’å‹•å¼åœ°åœ–é¡¯ç¤ºæ‰€æœ‰é¤å»³ä½ç½®",
                "ğŸ” æœå°‹ç‰¹å®šé¤å»³æˆ–ç¾é£Ÿé¡å‹",
                "ğŸ“ é»æ“Šåœ°åœ–æ¨™è¨˜æŸ¥çœ‹é¤å»³è©³ç´°è³‡è¨Š",
                "â­ æŸ¥çœ‹å…¶ä»–ç”¨æˆ¶çš„è©•åƒ¹èˆ‡è©•åˆ†",
                "ğŸ“± ç²å–é¤å»³è¯çµ¡æ–¹å¼èˆ‡ç‡Ÿæ¥­æ™‚é–“",
                "ğŸš¶ æŸ¥çœ‹å¾æ‚¨ç•¶å‰ä½ç½®åˆ°é¤å»³çš„è·¯ç·š"
            ],
            "how_to": "åœ¨åœ°åœ–ä¸Šé»æ“Šç´…è‰²æ¨™è¨˜æŸ¥çœ‹é¤å»³è©³æƒ…ï¼Œä½¿ç”¨å·¦ä¸Šè§’æœå°‹æ¡†å¿«é€Ÿæ‰¾åˆ°ç‰¹å®šé¤å»³ï¼Œæˆ–ä½¿ç”¨ç¯©é¸åŠŸèƒ½æŒ‰ç…§è©•åˆ†ã€è·é›¢ç­‰æ¢ä»¶ç¯©é¸ã€‚"
        },
        "restaurant_list": {
            "name": "é¤å»³åˆ—è¡¨",
            "intro": "ä»¥æ¸…å–®å½¢å¼ç€è¦½æ‰€æœ‰é¤å»³ï¼Œæ–¹ä¾¿æ¯”è¼ƒå’Œç¯©é¸ã€‚",
            "features": [
                "ğŸ“‹ å®Œæ•´çš„é¤å»³æ¸…å–®æª¢è¦–",
                "ğŸ”½ æŒ‰åç¨±ã€è©•åˆ†ã€è·é›¢ç­‰æ’åº",
                "ğŸ·ï¸ æŒ‰æ–™ç†é¡å‹ã€åƒ¹ä½ç­‰ç¯©é¸",
                "â­ å¿«é€ŸæŸ¥çœ‹è©•åˆ†èˆ‡è©•è«–æ‘˜è¦",
                "ğŸ”— é»æ“Šé€²å…¥é¤å»³è©³ç´°é é¢"
            ],
            "how_to": "ä½¿ç”¨é é¢é ‚éƒ¨çš„æ’åºå’Œç¯©é¸é¸é …æ‰¾åˆ°ç¬¦åˆéœ€æ±‚çš„é¤å»³ï¼Œé»æ“Šé¤å»³åç¨±æŸ¥çœ‹è©³ç´°è³‡è¨Šã€‚"
        },
        "restaurant_detail": {
            "name": "é¤å»³è©³æƒ…",
            "intro": "æ·±å…¥äº†è§£ç‰¹å®šé¤å»³çš„æ‰€æœ‰è³‡è¨Šã€‚",
            "features": [
                "ğŸª é¤å»³åŸºæœ¬è³‡è¨Šï¼ˆåœ°å€ã€é›»è©±ã€ç‡Ÿæ¥­æ™‚é–“ï¼‰",
                "ğŸœ å®Œæ•´èœå–®èˆ‡åƒ¹æ ¼",
                "ğŸ“¸ é¤å»³èˆ‡æ–™ç†ç…§ç‰‡",
                "ğŸ’¬ ç”¨æˆ¶è©•è«–èˆ‡è©•åˆ†",
                "ğŸ—ºï¸ ä½ç½®åœ°åœ–èˆ‡äº¤é€šè³‡è¨Š"
            ],
            "how_to": "ç€è¦½é¤å»³è³‡è¨Šï¼ŒæŸ¥çœ‹èœå–®é¸æ“‡é¤é»ï¼Œé–±è®€å…¶ä»–ç”¨æˆ¶è©•è«–å¹«åŠ©æ±ºç­–ã€‚"
        },
        "ai_food_analysis": {
            "name": "AIé£Ÿç‰©ç‡Ÿé¤Šåˆ†æ",
            "intro": "é‹ç”¨AIæŠ€è¡“åˆ†æé£Ÿç‰©ç‡Ÿé¤Šæˆåˆ†ï¼Œå¹«åŠ©æ‚¨äº†è§£æ¯ä¸€é¤çš„ç‡Ÿé¤Šåƒ¹å€¼ã€‚",
            "features": [
                "ğŸ” è¼¸å…¥é£Ÿç‰©åç¨±é€²è¡Œç‡Ÿé¤Šåˆ†æ",
                "ğŸ“Š ç”Ÿæˆè©³ç´°ç‡Ÿé¤Šæˆåˆ†åœ–è¡¨",
                "ğŸ¥— ç²å¾—ç‡Ÿé¤Šåƒ¹å€¼è©•ä¼°",
                "ğŸ’¡ æ”¶åˆ°å€‹äººåŒ–ç‡Ÿé¤Šå»ºè­°",
                "ğŸ“‹ ä¿å­˜åˆ†æè¨˜éŒ„åˆ°å€‹äººæ—¥è¨˜"
            ],
            "how_to": "åœ¨è¼¸å…¥æ¡†ä¸­æè¿°æ‚¨è¦åˆ†æçš„é£Ÿç‰©ï¼ˆå¦‚ï¼šéº»å©†è±†è…é£¯ï¼‰ï¼Œé»æ“Šåˆ†ææŒ‰éˆ•ï¼ŒAIæœƒç‚ºæ‚¨ç”Ÿæˆç‡Ÿé¤Šå ±å‘Šå’Œå»ºè­°ã€‚"
        },
        "ai_nutrition_consultant": {
            "name": "AIç‡Ÿé¤Šé¡§å•",
            "intro": "æ‚¨çš„å°ˆå±¬AIç‡Ÿé¤Šå¸«ï¼æä¾›å°ˆæ¥­çš„ç‡Ÿé¤Šè«®è©¢èˆ‡å¥åº·é£²é£Ÿå»ºè­°ï¼Œæ”¯æ´å³æ™‚å°è©±äº’å‹•ã€‚",
            "features": [
                "ğŸ©º å°ˆæ¥­ç‡Ÿé¤Šå¸«ç´šåˆ¥çš„å¥åº·è«®è©¢",
                "ğŸ’¬ å³æ™‚å°è©±å¼äº’å‹•é«”é©—",
                "ğŸ¯ å€‹äººåŒ–æ¸›è‚¥ã€å¢è‚Œã€ç–¾ç—…èª¿ç†å»ºè­°",
                "ğŸƒâ€â™‚ï¸ é‹å‹•ç‡Ÿé¤Šèˆ‡å¥èº«é£²é£ŸæŒ‡å°",
                "ğŸ“š åŸºæ–¼ç§‘å­¸ä¾æ“šçš„ç‡Ÿé¤ŠçŸ¥è­˜åˆ†äº«",
                "âš¡ å¿«é€Ÿå›æ‡‰å„ç¨®ç‡Ÿé¤Šå¥åº·å•é¡Œ"
            ],
            "how_to": "ç›´æ¥åœ¨èŠå¤©æ¡†ä¸­è¼¸å…¥æ‚¨çš„å•é¡Œï¼Œå¦‚ï¼š'æˆ‘æƒ³æ¸›è‚¥è©²æ€éº¼åƒï¼Ÿ'æˆ–é»æ“Šå»ºè­°å•é¡ŒæŒ‰éˆ•å¿«é€Ÿé–‹å§‹å°è©±ã€‚AIç‡Ÿé¤Šå¸«æœƒæ ¹æ“šæ‚¨çš„æƒ…æ³æä¾›å°ˆæ¥­å»ºè­°ã€‚"
        },
        "personal_food_diary": {
            "name": "å€‹äººé£²é£Ÿæ—¥è¨˜",
            "intro": "è¨˜éŒ„èˆ‡è¿½è¹¤æ‚¨çš„æ¯æ—¥é£²é£Ÿï¼Œå»ºç«‹å¥åº·çš„é£²é£Ÿç¿’æ…£ã€‚",
            "features": [
                "ğŸ“ è¨˜éŒ„æ¯æ—¥é¤é£Ÿå…§å®¹",
                "ğŸ“Š æŸ¥çœ‹ç‡Ÿé¤Šæ”å–çµ±è¨ˆ",
                "ğŸ“… æŒ‰æ—¥æœŸç€è¦½é£²é£Ÿæ­·å²",
                "ğŸ¯ è¨­å®šå€‹äººç‡Ÿé¤Šç›®æ¨™",
                "ğŸ“ˆ è¿½è¹¤é£²é£Ÿæ”¹å–„é€²åº¦"
            ],
            "how_to": "é»æ“Š'æ–°å¢è¨˜éŒ„'æŒ‰éˆ•ï¼Œè¼¸å…¥ä»Šå¤©åƒçš„é£Ÿç‰©ï¼Œç³»çµ±æœƒè‡ªå‹•è¨ˆç®—ç‡Ÿé¤Šæˆåˆ†ä¸¦åŠ å…¥æ‚¨çš„é£²é£Ÿæ—¥è¨˜ã€‚"
        },
        "personal_nutrition_dashboard": {
            "name": "å€‹äººç‡Ÿé¤Šå„€è¡¨æ¿",
            "intro": "ä¸€ç›®äº†ç„¶æ‚¨çš„ç‡Ÿé¤Šç‹€æ³ï¼Œå”åŠ©é”æˆå¥åº·ç›®æ¨™ã€‚",
            "features": [
                "ğŸ“Š ç‡Ÿé¤Šæ”å–è¦–è¦ºåŒ–åœ–è¡¨",
                "ğŸ¯ ç›®æ¨™é”æˆåº¦è¿½è¹¤",
                "ğŸ“ˆ é€±/æœˆç‡Ÿé¤Šè¶¨å‹¢åˆ†æ",
                "âš¡ ç‡Ÿé¤Šæ”å–å»ºè­°æé†’",
                "ğŸ† å¥åº·é‡Œç¨‹ç¢‘è¨˜éŒ„"
            ],
            "how_to": "æŸ¥çœ‹åœ–è¡¨äº†è§£ç‡Ÿé¤Šæ”å–ç‹€æ³ï¼Œé»æ“Šå„å€‹æŒ‡æ¨™ç²å¾—è©³ç´°èªªæ˜ï¼Œæ ¹æ“šå»ºè­°èª¿æ•´é£²é£Ÿç¿’æ…£ã€‚"
        },
        "ai_recommendation": {
            "name": "AIç¾é£Ÿæ¨è–¦",
            "intro": "åŸºæ–¼æ‚¨çš„åå¥½èˆ‡éœ€æ±‚ï¼ŒAIç‚ºæ‚¨æ¨è–¦æœ€é©åˆçš„é¤å»³èˆ‡é¤é»ã€‚",
            "features": [
                "ğŸ¤– å€‹äººåŒ–é¤å»³æ¨è–¦",
                "ğŸ½ï¸ æ ¹æ“šç‡Ÿé¤Šéœ€æ±‚æ¨è–¦é¤é»",
                "ğŸ¯ è€ƒé‡é ç®—èˆ‡è·é›¢çš„æ™ºèƒ½æ¨è–¦",
                "â­ çµåˆè©•åƒ¹çš„å„ªè³ªæ¨è–¦",
                "ğŸ”„ æŒçºŒå­¸ç¿’æ‚¨çš„åå¥½"
            ],
            "how_to": "å¡«å¯«æ‚¨çš„åå¥½ï¼ˆæ–™ç†é¡å‹ã€é ç®—ã€è·é›¢ç­‰ï¼‰ï¼ŒAIæœƒç‚ºæ‚¨æ¨è–¦æœ€åˆé©çš„é¸æ“‡ã€‚è¶Šå¤šäº’å‹•ï¼Œæ¨è–¦è¶Šç²¾æº–ï¼"
        },
        "checkin_list": {
            "name": "æ‰“å¡è¨˜éŒ„",
            "intro": "è¨˜éŒ„æ‚¨çš„ç¾é£Ÿè¶³è·¡ï¼Œèˆ‡æœ‹å‹åˆ†äº«ç”¨é¤é«”é©—ã€‚",
            "features": [
                "ğŸ“ é¤å»³æ‰“å¡è¨˜éŒ„",
                "â­ ç‚ºé¤å»³è©•åˆ†èˆ‡è©•è«–",
                "ğŸ“¸ åˆ†äº«ç”¨é¤ç…§ç‰‡",
                "ğŸ† æŸ¥çœ‹å€‹äººæ‰“å¡çµ±è¨ˆ",
                "ğŸ‘¥ ç€è¦½æœ‹å‹çš„ç”¨é¤å‹•æ…‹"
            ],
            "how_to": "åœ¨é¤å»³ç”¨é¤æ™‚é»æ“Šæ‰“å¡æŒ‰éˆ•ï¼Œç‚ºé¤å»³è©•åˆ†ä¸¦åˆ†äº«æ‚¨çš„ç”¨é¤æ„Ÿå—ã€‚"
        },
        "article_list": {
            "name": "ç¾é£Ÿæ–‡ç« ",
            "intro": "æ¢ç´¢è±å¯Œçš„ç¾é£Ÿæ–‡ç« ï¼Œç²å¾—é£²é£Ÿéˆæ„Ÿèˆ‡çŸ¥è­˜ã€‚",
            "features": [
                "ğŸ“° é–±è®€æœ€æ–°ç¾é£Ÿæ–‡ç« ",
                "âœï¸ ç™¼è¡¨å€‹äººç¾é£Ÿå¿ƒå¾—",
                "ğŸ’¬ èˆ‡å…¶ä»–ç”¨æˆ¶äº¤æµè¨è«–",
                "ğŸ”– æ”¶è—å–œæ„›çš„æ–‡ç« ",
                "ğŸ” æœå°‹ç‰¹å®šä¸»é¡Œæ–‡ç« "
            ],
            "how_to": "ç€è¦½æ–‡ç« åˆ—è¡¨ï¼Œé»æ“Šæ¨™é¡Œé–±è®€å…¨æ–‡ï¼Œç™»å…¥å¾Œå¯ç™¼è¡¨è©•è«–æˆ–æ’°å¯«è‡ªå·±çš„ç¾é£Ÿæ–‡ç« ã€‚"
        },
        "social": {
            "name": "ç¤¾äº¤åŠŸèƒ½",
            "intro": "èˆ‡åŒå­¸æœ‹å‹åˆ†äº«ç¾é£Ÿé«”é©—ï¼Œå»ºç«‹ç¾é£Ÿç¤¾ç¾¤ã€‚",
            "features": [
                "ğŸ‘¥ æ·»åŠ å¥½å‹èˆ‡é—œæ³¨",
                "ğŸ’¬ ç§è¨Šèˆ‡ç¾¤çµ„èŠå¤©",
                "ğŸ“± åˆ†äº«ç”¨é¤å‹•æ…‹",
                "ğŸ‰ åƒåŠ ç¾é£Ÿæ´»å‹•",
                "ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œèˆ‡æˆå°±"
            ],
            "how_to": "æœå°‹ä¸¦æ·»åŠ æœ‹å‹ï¼Œåˆ†äº«æ‚¨çš„ç”¨é¤é«”é©—ï¼Œåƒèˆ‡ç¤¾ç¾¤è¨è«–ï¼Œä¸€èµ·æ¢ç´¢æ ¡åœ’ç¾é£Ÿï¼"
        }
    }

    # ç²å–ç•¶å‰é é¢çš„è©³ç´°è³‡è¨Š
    page_info = page_details.get(current_page)
    if not page_info:
        # é è¨­å›æ‡‰
        intro = "é€™æ˜¯ NCU é£Ÿç‰©åœ°åœ–ç¶²ç«™ï¼Œæ‚¨å¯ä»¥æŸ¥è©¢æ ¡åœ’é™„è¿‘ç¾é£Ÿã€ç‡Ÿé¤Šè³‡è¨Šèˆ‡å¥åº·å»ºè­°ã€‚å¦‚éœ€ç¶²ç«™æ“ä½œèªªæ˜ï¼Œæ­¡è¿éš¨æ™‚è©¢å•ï¼"
    else:
        intro = f"æ‚¨ç›®å‰åœ¨ã€{page_info['name']}ã€‘\n\n{page_info['intro']}\n\nä¸»è¦åŠŸèƒ½ï¼š\n" + "\n".join(page_info['features']) + f"\n\nä½¿ç”¨æ–¹å¼ï¼š{page_info['how_to']}"

    # çµ„åˆ prompt
    system_prompt = f"""ä½ æ˜¯ NCU é£Ÿç‰©åœ°åœ–ç¶²ç«™çš„ AI åŠ©æ‰‹ï¼Œåªè² è²¬ç¶²ç«™å°è¦½èˆ‡åŠŸèƒ½ä»‹ç´¹ã€‚è«‹æ ¹æ“šç”¨æˆ¶æ‰€åœ¨çš„é é¢è©³ç´°èªªæ˜è©²é é¢çš„ç”¨é€”ã€ä¸»è¦åŠŸèƒ½ã€æ“ä½œæ–¹å¼ã€‚é‡åˆ°å¥åº·ã€ç‡Ÿé¤Šã€é£²é£Ÿã€ç–¾ç—…ç­‰å•é¡Œæ™‚ï¼Œè«‹ç¦®è²Œåœ°å»ºè­°ç”¨æˆ¶å‰å¾€ã€æ™ºèƒ½ç‡Ÿé¤Šé¡§å•ã€é é¢è©¢å•ã€‚

ç•¶å‰é é¢è³‡è¨Šï¼š{intro}

è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£è¦ªåˆ‡å‹å¥½ã€‚å¦‚æœç”¨æˆ¶è©¢å•å…¶ä»–é é¢åŠŸèƒ½ï¼Œå¯ä»¥ç°¡å–®ä»‹ç´¹ä¸¦å»ºè­°å‰å¾€è©²é é¢ä½¿ç”¨ã€‚"""
    
    user_prompt = f"ç”¨æˆ¶åœ¨ã€{page_info['name'] if page_info else current_page}ã€‘é é¢æå•ï¼š{message}"

    # å‘¼å« Together AI ç”Ÿæˆç¶²ç«™å°è¦½èªªæ˜
    try:
        logger.info(f"Sending request to Together API with prompt: {user_prompt}")
        response = requests.post(
            "https://api.together.xyz/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {API_KEY}",
                "Content-Type": "application/json"
            },
            json={
                "model": "mistralai/Mixtral-8x7B-Instruct-v0.1",
                "messages": [
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                "temperature": 0.7,
                "max_tokens": 500
            },
            timeout=30
        )
        logger.info(f"API Response status: {response.status_code}")
        logger.info(f"API Response content: {response.text[:500]}")
        if response.status_code == 200:
            response_data = response.json()
            if 'choices' in response_data and len(response_data['choices']) > 0:
                return response_data['choices'][0]['message']['content'].strip()
            else:
                logger.error(f"Unexpected API response structure: {response_data}")
                return intro
        else:
            logger.error(f"API request failed with status {response.status_code}: {response.text}")
            return intro
    except Exception as e:
        logger.error(f"Error in get_ai_response: {str(e)}", exc_info=True)
        return intro

@csrf_exempt
@require_POST
def chat(request):
    """è™•ç†èŠå¤©è«‹æ±‚"""
    try:
        data = json.loads(request.body)
        message = data.get('message')
        current_page = data.get('current_page', '')
        
        logger.info(f"Received chat request - Message: {message}, Page: {current_page}")
        
        if not message:
            return JsonResponse({'error': 'è«‹è¼¸å…¥è¨Šæ¯'}, status=400)
        
        # ç²å–AIå›æ‡‰
        response = get_ai_response(message, current_page)
        
        # ä¿å­˜å°è©±æ­·å²
        ChatHistory.objects.create(
            user=request.user if request.user.is_authenticated else None,
            session_id=request.session.session_key or '',
            message=message,
            response=response,
            current_page=current_page
        )
        
        return JsonResponse({'response': response})
    except Exception as e:
        logger.error(f"Error in chat view: {str(e)}", exc_info=True)
        return JsonResponse({'error': str(e)}, status=500)

@require_GET
def get_chat_history(request):
    """ç²å–ç”¨æˆ¶çš„èŠå¤©æ­·å²è¨˜éŒ„"""
    try:
        # ç²å–æœ€è¿‘çš„5çµ„å°è©±
        history = ChatHistory.objects.filter(
            user=request.user if request.user.is_authenticated else None,
            session_id=request.session.session_key
        ).order_by('-created_at')[:10]  # ç²å–æœ€è¿‘çš„10æ¢æ¶ˆæ¯ï¼ˆ5çµ„å°è©±ï¼‰
        
        # å°‡æŸ¥è©¢çµæœè½‰æ›ç‚ºåˆ—è¡¨ä¸¦åè½‰é †åºï¼ˆè®“æœ€æ—©çš„æ¶ˆæ¯åœ¨å‰ï¼‰
        messages = []
        for chat in reversed(list(history)):
            messages.append({
                'type': 'user',
                'content': chat.message
            })
            messages.append({
                'type': 'assistant',
                'content': chat.response
            })
            
        return JsonResponse({'messages': messages})
    except Exception as e:
        logger.error(f"Error in get_chat_history: {str(e)}", exc_info=True)
        return JsonResponse({'error': str(e)}, status=500)
